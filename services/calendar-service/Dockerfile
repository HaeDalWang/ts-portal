# ğŸš€ UV ê¸°ë°˜ Dockerfile - ê·¹ë„ë¡œ ë¹ ë¥¸ ë¹Œë“œ!
FROM python:3.11-slim

LABEL maintainer="TS Portal Team"
LABEL description="calendar-service - UV ê¸°ë°˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤"

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    curl \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# UV ì„¤ì¹˜ (ê³µì‹ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Python í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬
COPY services/calendar-service/pyproject.toml services/calendar-service/uv.lock* ./

# UVë¡œ ì˜ì¡´ì„± ì„¤ì¹˜ (ê°€ìƒí™˜ê²½ ì—†ì´ ì‹œìŠ¤í…œì— ì§ì ‘ ì„¤ì¹˜)
ENV UV_SYSTEM_PYTHON=1
RUN uv sync --frozen --no-dev

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY services/calendar-service/app/ ./app/

# shared ëª¨ë“ˆ ë³µì‚¬
COPY services/shared/ ./shared/

# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /app/logs

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8000

# í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# UVë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["uv", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"] 